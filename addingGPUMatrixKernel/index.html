<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://sparcityeu.github.io/sparseviz/addingGPUMatrixKernel/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Adding GPU Matrix Kernel - SparseViz</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Adding GPU Matrix Kernel";
        var mkdocs_page_input_path = "addingGPUMatrixKernel.md";
        var mkdocs_page_url = "/sparseviz/addingGPUMatrixKernel/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> SparseViz
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../configUse/">Config File</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">EXTENDING LIBRARY BEYOND</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../addingMatrixOrdering/">Adding Matrix Ordering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../addingTensorOrdering/">Adding Tensor Ordering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../addingCPUMatrixKernel/">Adding CPU Matrix Kernel</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Adding GPU Matrix Kernel</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../addingCPUTensorKernel/">Adding CPU Tensor Kernel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../addingGPUTensorKernel/">Adding GPU Tensor Kernel</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../licence/">Licence</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">SparseViz</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">EXTENDING LIBRARY BEYOND</li>
      <li class="breadcrumb-item active">Adding GPU Matrix Kernel</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="tutorial-42-how-to-add-gpu-matrix-kernel">Tutorial 4.2: How to Add GPU Matrix Kernel</h1>
<p>In this tutorial, we will have a look at how GPU matrix kernels are
added to the SparseViz library. All user-defined GPU matrix kernel
classes should derive from the abstract MatrixGPUKernel class that
facilitates the integration of kernels into SparseViz. As indicated
previously, GPU matrix kernel parallelization is made possible with Cuda
in the SparseViz library. That's why, along the way, we are going to
need .cu and .cuh files in which to implement our parallel device
kernels that are going to be executed on GPU. First stop, we are going
to create our class declaration under the directory
SparseViz/include/Kernel/Matrix/GPU.</p>
<p><em>AddingGPUMatrixKernel.h</em></p>
<pre><code class="language-cpp">#include &quot;MatrixGPUKernel.h&quot;

class AddingGPUMatrixKernel: public MatrixGPUKernel

{

public:

    AddingGPUMatrixKernel(const std::string&amp; kernelName, const std::vector&lt;int&gt;&amp; gridSizes, const std::vector&lt;int&gt;&amp; blockSizes, int nRun, int nIgnore)
    :   MatrixGPUKernel(kernelName, gridSizes, blockSizes, nRun, nIgnore) {}

    virtual ~AddingGPUMatrixKernel() override;

    virtual bool init(const SparseMatrix&amp; A);

    virtual void preprocess(const SparseMatrix&amp; A) {}

    virtual void hostFunction(const SparseMatrix&amp; A, int iterNumber, int gridSize, int blockSize);

};
</code></pre>
<p>It is almost the same declaration as Matrix CPU kernel except that the
functionBody name has been changed with hostFunction and it takes
additional 2 parameters indicating the gridSize and the blockSize of the
current iteration.</p>
<p>Now it is time for the implementation file, which we will create under
the directory SparseViz/src/Kernel/Matrix/GPU.</p>
<p><em>AddingGPUMatrixKernel.cu</em></p>
<pre><code class="language-cpp">#include &quot;AddingGPUMatrixKernel.h&quot;

#include &quot;GPUKernels.cuh&quot;

#include &quot;cuda_runtime.h&quot;

bool AddingGPUMatrixKernel::init(const SparseMatrix &amp;A)

{

    if (// some checks may be done)

    {

        return false;

    }

    // Your initialization code goes here

    return true;

}

AddingGPUMatrixKernel::~AddingGPUMatrixKernel()

{

    // Your destructor code goes here

}

void AddingGPUMatrixKernel::hostFunction(const SparseMatrix &amp;A, int iterNumber, int gridSize, int blockSize)

{

    // Your host function code goes here, including Cuda memcpy and malloc statements.

    GPUMatrixKernel&lt;&lt;&lt;gridSize, blockSize&gt;&gt;&gt;(// Your gpu kernel parameters goes here);

    // Your host function code continues from there, including Cuda memcpy and free statements.

}
</code></pre>
<p>Some parts require details in the above source code. First, it is
important to realize that the file does not have a normal cpp source
code extension but has a .cu extension that requires compilation to be
done by the nvcc compiler. As a second remark, there is an additional
include from which GPUMatrixKernel declaration is received. Users may
include their device kernel declarations into
SparseViz/include/Kernel/GPUKernels.cuh file. From there, the
appropriate device kernel can be called as shown by the hostFunction
which we have completed its implementation of. Device kernel declaration
is done under GPUKernels.cuh cuda header file looks like the following:</p>
<p><em>GPUKernels.cuh</em></p>
<pre><code class="language-cpp">--- OTHER DEVICE KERNEL DECLARATIONS (CROPPED) ---

__global__ void GPUMatrixKernel(// Your device kernel parameters goes here);
</code></pre>
<p>Similarly, its implementation could be done in the
SparseViz/src/Kernel/GPUKernels.cu file that looks like the following:</p>
<p><em>GPUKernels.cu</em></p>
<pre><code class="language-cpp">__global__ void GPUMatrixKernel(// Your device kernel parameters goes here)

{

    // Your device kernel implementation goes here

}
</code></pre>
<p>Having made all necessary declarations and implementations both for our
host and device functions, we can proceed to add them into
CMakeLists.txt. Because .cu files are compiled only when Cuda and
Cuda-capable GPU are installed, we are going to add the files into
CMakeLists.txt conditionally, like so:</p>
<p><em>CMakeLists.txt</em></p>
<pre><code class="language-cpp">include(CheckLanguage)

check_language(CUDA)

if(CMAKE_CUDA_COMPILER)

    enable_language(CUDA)

    add_definitions(-DCUDA_ENABLED)

    --- OTHER HEADER FILE APPEND STATEMENTS (CROPPED) ---

    list(APPEND HEADER_FILES include/Kernel/Matrix/GPU/AddingGPUMatrixKernel.h)

    --- OTHER SOURCE FILE APPEND STATEMENTS (CROPPED) ---

    list(APPEND SOURCE_FILES src/Kernel/Matrix/GPU/AddingGPUMatrixKernel.cu)

endif()
</code></pre>
<p>As a final step, we will introduce our matrix GPU kernel definition into
the SparseVizEngine, enabling the library to recognize and utilize this
new kernel. The only part to pay attention to is that every code that we
are going to include should be within a conditional macro named
CUDA_ENABLED.</p>
<p><em>SparseVizEngine.h</em></p>
<pre><code class="language-cpp">#ifdef CUDA_ENABLED

--- OTHER GPU KERNEL INCLUDES (CROPPED) ---

#include &quot;AddingGPUMatrixKernel.h&quot;

#endif
</code></pre>
<p><em>SparseVizEngine.cpp</em></p>
<pre><code class="language-cpp">#ifdef CUDA_ENABLED

MatrixGPUKernel *SparseVizEngine::matrixGPUKernelFactory(const std::string &amp;kernelName, const std::vector&lt;int&gt; &amp;gridSizes, const std::vector&lt;int&gt; &amp;blockSizes, int nRun, int nIgnore)

{

    --- OTHER GPU KERNEL CLASSES (CROPPED) ---

    else if (kernelName == &quot;AddingGPUMatrixKernel&quot;)

    {

        return new AddingGPUMatrixKernel(kernelName, gridSizes, blockSizes, nRun, nIgnore);

    }

    return nullptr;

}

#endif
</code></pre>
<p>Finally, we can run or GPU matrix kernel from the config file by
indicating it under the section named *GPU_MATRIX_KERNELS*, as
follows:</p>
<p><em>config</em></p>
<pre><code class="language-cpp">*GPU_MATRIX_KERNELS*

AddingGPUMatrixKernel | 4 | 256 | 10 | 2
</code></pre>
<p>This concludes tutorial 4.2, adding GPU matrix kernel into the SparseViz
library.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../addingCPUMatrixKernel/" class="btn btn-neutral float-left" title="Adding CPU Matrix Kernel"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../addingCPUTensorKernel/" class="btn btn-neutral float-right" title="Adding CPU Tensor Kernel">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../addingCPUMatrixKernel/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../addingCPUTensorKernel/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
